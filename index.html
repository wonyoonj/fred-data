<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; min-height: 10vh; }
        .header { text-align: center; padding: 10px; background: #007bff; color: white; }
        .back-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; cursor: pointer; font-size: 24px; font-weight: bold; color: black; width: 30px; text-align: center; }
        .back-btn::before { content: "◄"; font-size: 36px; }
        .info-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; font-size: 20px; }
        .button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .button:hover { background: #0056b3; }

        #liquidityFlow {
            text-align: center;
            padding: 20px;
            position: relative;
            height: 600px; /* 수정됨: 아이콘 이동에 따른 높이 확보 */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #liquidityFlow .icon-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
        }
        #liquidityFlow .icon {
            width: 80px;
            height: 80px;
            display: block;
            object-fit: contain;
        }
        #liquidityFlow .icon-label {
            font-weight: bold;
            color: black;
            font-size: 14px;
            white-space: nowrap;
            margin-top: 5px;
        }

        .FED-container .icon-label {
            order: -1;
            margin-bottom: 5px;
            margin-top: 0;
        }

        /* 아이콘 위치 수정됨 */
        .FED-container { top: 15%; left: 50%; }
        .Government-container { top: 52%; left: 20%; }
        .Market-container { top: 85%; left: 50%; }
        .MMF-container { top: 52%; left: 80%; }

        #tgaSlopeDisplay, #fedLiquidityDisplay, #mmfToRrpDisplay, #mmfToMarketDisplay, #netMarketFlowDisplay {
            position: absolute;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 6px;
            border-radius: 5px;
            border: 1px solid #ccc;
            text-align: center;
        }
        
        /* [수정 1 시작] 시장 아이콘 아래 계산 결과값 위치 */
        #netMarketFlowDisplay {
            display: inline-block;
            top: 93%;
            left: 50%;
            background: none;
            border: none;
            font-size: 0.9em;
        }
        /* [수정 1 끝] */

        /* 팝업 컨테이너 및 팝업 스타일 */
        .tga-popup-container, .fed-popup-container, .mmf-fed-popup-container, .mmf-market-popup-container {
            position: absolute;
            z-index: 20;
        }

        .tga-popup-container:hover,
        .fed-popup-container:hover,
        .mmf-fed-popup-container:hover,
        .mmf-market-popup-container:hover {
            z-index: 30; /* 마우스를 올렸을 때 z-index를 높여 최상단으로 올림 */
        }
        
        /* 레이블 위치 수정됨 */
        .tga-popup-container {
            top: calc(55% + 40px + 5px);
            left: 30%;
            transform: translateX(-50%);
        }

        .fed-popup-container {
            top: calc(33% - 40px - 10px);
            left: 45%;
            transform: translateX(-50%);
        }
        
        .mmf-fed-popup-container {
            top: calc(37% - 40px - 10px);
            left: 80%;
            transform: translateX(-50%);
        }

        .mmf-market-popup-container {
            top: calc(58% + 40px);
            left: 80%;
            transform: translateX(-50%);
        }

        .tooltip-container {
            visibility: hidden;
            background-color: #555;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            /* 팝업 창이 모든 레이블보다 앞에 표시되도록 z-index 값을 매우 높게 설정 */
            z-index: 9999;
            /* 기본 위치는 위쪽 */
            bottom: 100%;
            left: 50%;
            margin-left: -100px;
            width: 180px;
            opacity: 0;
            transition: opacity 0.3s;
            line-height: 1.5;
            white-space: normal;
        }
        
        /* 수정됨: 아래에 표시될 툴팁 스타일 */
        .fed-popup-container .tooltip-container,
        .mmf-fed-popup-container .tooltip-container {
            bottom: auto;
            top: 100%;
            margin-top: 10px; /* 약간의 간격 추가 */
        }

        .tooltip-container p {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: normal;
        }

        .tooltip-container .graph-btn {
            background: #009688;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .tooltip-container .update-date {
            font-size: 10px;
            color: #ccc;
            text-align: right;
            margin-top: 10px;
            display: block;
        }
        
        /* 기본 화살표 (아래를 향함) */
        .tooltip-container::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        
        /* 수정됨: 위를 향하는 화살표 */
        .fed-popup-container .tooltip-container::after,
        .mmf-fed-popup-container .tooltip-container::after {
            top: auto;
            bottom: 100%;
            border-color: transparent transparent #555 transparent;
        }

        /* 수정됨: 툴팁 위치 중앙으로 조정 */
        .tga-popup-container:hover .tooltip-container {
            margin-left: -50px; /* 오른쪽으로 이동 */
        }
        .fed-popup-container:hover .tooltip-container {
            margin-left: -50px; /* 오른쪽으로 이동 */
            top: -0.2px;
        }
        .mmf-fed-popup-container:hover .tooltip-container {
            margin-left: -220px; /* 왼쪽으로 이동 */
            top: -0.2px;
        }
        .mmf-market-popup-container:hover .tooltip-container {
            margin-left: -220px; /* 왼쪽으로 이동 */
        }


        .tga-popup-container:hover .tooltip-container,
        .fed-popup-container:hover .tooltip-container,
        .mmf-fed-popup-container:hover .tooltip-container,
        .mmf-market-popup-container:hover .tooltip-container {
            visibility: visible;
            opacity: 1;
        }

        #tgaSlopeDisplay, #fedLiquidityDisplay, #mmfToRrpDisplay, #mmfToMarketDisplay {
            position: relative;
            z-index: 10;
            cursor: help;
        }
        
        .slope-positive { color: red; }
        .slope-negative { color: blue; }

        .dollar-animated-object {
            position: absolute;
            object-fit: contain;
            opacity: 0;
            z-index: 5;
        }

        /* 애니메이션 좌표 수정됨 */
        @keyframes dollarFlowToMarket {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
        }

        @keyframes dollarFlowToFED {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
        }

        @keyframes dollarFlowToGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 52%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 52%; }
        }

        @keyframes dollarFlowFromGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 52%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 52%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
        }

        @keyframes dollarFlowFromMmfToFed {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
        }
        @keyframes dollarFlowFromFedToMmf {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
        }
        
        @keyframes dollarFlowFromMmfToMarket_parabolic {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            50% { transform: translate(-50%, -50%) scale(1) translateY(50px); opacity: 1; left: 65%; top: 70%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
        }
        @keyframes dollarFlowFromMarketToMmf_parabolic {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 85%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 85%; }
            50% { transform: translate(-50%, -50%) scale(1) translateY(50px); opacity: 1; left: 65%; top: 70%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
        }

        @keyframes dollarFlowFromMmfToGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 52%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 52%; }
        }
        @keyframes dollarFlowFromGovernmentToMmf {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 52%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 52%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 52%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 52%; }
        }


        .animated-dollar-to-market { animation: dollarFlowToMarket var(--animation-duration) linear forwards; }
        .animated-dollar-to-fed { animation: dollarFlowToFED var(--animation-duration) linear forwards; }
        .animated-dollar-to-government { animation: dollarFlowToGovernment var(--animation-duration) linear forwards; }
        .animated-dollar-from-government { animation: dollarFlowFromGovernment var(--animation-duration) linear forwards; }
        
        .animated-dollar-from-mmf-to-fed { animation: dollarFlowFromMmfToFed var(--animation-duration) linear forwards; }
        .animated-dollar-from-fed-to-mmf { animation: dollarFlowFromFedToMmf var(--animation-duration) linear forwards; }
        
        .animated-dollar-from-mmf-to-market_parabolic { animation: dollarFlowFromMmfToMarket_parabolic var(--animation-duration) linear forwards; }
        .animated-dollar-from-market-to-mmf_parabolic { animation: dollarFlowFromMarketToMmf_parabolic var(--animation-duration) linear forwards; }

        #graphIndicators { padding: 20px; text-align: center; }
        .indicator-section { margin-bottom: 20px; }
        .indicator-section h3 { font-size: 18px; margin-bottom: 10px; color: #007bff; }
        .indicator-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        #graphPage {
            text-align: center;
            padding: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #graphPage canvas {
            max-width: 100%;
            width: 100%;
            height: 400px;
            cursor: grab;
            flex-grow: 1;
        }

        #infoPage { padding: 20px; text-align: center; }
        .time-buttons { margin: 10px 0; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .time-btn { padding: 5px 10px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .time-btn:hover { background-color: #dee2e6; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #007bff; padding: 10px; display: flex; justify-content: space-around; }

        @media (max-width: 600px) {
            .container { padding: 10px; }
            .back-btn { top: 5px; left: 5px; }
            .info-btn { top: 5px; right: 5px; }

            #liquidityFlow .icon { width: 60px; height: 60px; }
            #liquidityFlow .icon-label { font-size: 12px; }

            /* 모바일 아이콘 위치 수정됨 */
            .FED-container { top: 15%; left: 50%; }
            .Government-container { top: 47%; left: 15%; }
            .Market-container { top: 80%; left: 50%; }
            .MMF-container { top: 47%; left: 85%; }

            /* [수정 2 시작] 모바일에서 시장 아이콘 아래 계산 결과값 위치 */
            #netMarketFlowDisplay {
                top: 90%;
            }
            /* [수정 2 끝] */

            #tgaSlopeDisplay, #fedLiquidityDisplay, #mmfToRrpDisplay, #mmfToMarketDisplay {
                font-size: 0.7em;
                padding: 2px 4px;
                white-space: normal;
            }

            /* [수정 3] 모바일에서 MMF 관련 라벨 넓이 고정 */
            #mmfToRrpDisplay, #mmfToMarketDisplay {
                width: 90px;
            }
            
            /* 모바일 레이블 위치 수정됨 */
            .tga-popup-container {
                top: calc(47% + 30px + 12px);
                left: 28%;
            }
            .fed-popup-container { 
                top: calc(28% - 30px - 5px);
                left: 42%;
            }
            /* 수정된 부분 2 */
            .mmf-fed-popup-container { 
                top: calc(30%);
                left: 85%;
            }
            .mmf-market-popup-container { 
                top: calc(55%);
                left: 85%;
            }
            /* 수정된 부분 2 끝 */

            .tooltip-container {
                margin-left: -100px;
                width: 200px;
            }
            
            .dollar-animated-object {
                width: 22.5px;
                height: 22.5px;
            }

            @keyframes dollarFlowToMarket {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            }
            @keyframes dollarFlowToFED {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
            }
            @keyframes dollarFlowToGovernment {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 15%; top: 47%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 15%; top: 47%; }
            }
            @keyframes dollarFlowFromGovernment {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 15%; top: 47%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 15%; top: 47%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            }
            @keyframes dollarFlowFromMmfToFed {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
            }
            @keyframes dollarFlowFromFedToMmf {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 15%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 15%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
            }
            @keyframes dollarFlowFromMmfToMarket_parabolic {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                50% { transform: translate(-50%, -50%) scale(1) translateY(25px); opacity: 1; left: 67.5%; top: 68%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            }
            @keyframes dollarFlowFromMarketToMmf_parabolic {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
                50% { transform: translate(-50%, -50%) scale(1) translateY(25px); opacity: 1; left: 67.5%; top: 68%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
            }
            @keyframes dollarFlowFromMmfToGovernment {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 15%; top: 47%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 15%; top: 47%; }
            }
            @keyframes dollarFlowFromGovernmentToMmf {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 15%; top: 47%; }
                20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 15%; top: 47%; }
                80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 85%; top: 47%; }
                100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 85%; top: 47%; }
            }

            .indicator-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                max-width: 100%;
            }
            .indicator-buttons .button {
                border: 1px solid black;
                width: 95%;
                margin: 5px auto;
            }

            .button { margin: 5px 0; }
            .time-buttons { justify-content: space-around; }
            .time-btn {
                padding: 5px 8px;
                font-size: 0.85em;
                margin: 2px;
                flex-basis: auto;
                width: auto;
            }
            #graphPage canvas {
                width: 100%;
                height: 300px;
            }
            .nav-bar { padding: 5px; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="container">
        <div id="liquidityFlow" class="page">
            <div class="tga-popup-container">
                <div id="tgaSlopeDisplay"></div>
                <div class="tooltip-container" id="tga-tooltip-content">
                </div>
            </div>
            
            <div class="fed-popup-container">
                <div id="fedLiquidityDisplay"></div>
                <div class="tooltip-container" id="fed-tooltip-content">
                </div>
            </div>

            <div class="mmf-fed-popup-container">
                <div id="mmfToRrpDisplay"></div>
                <div class="tooltip-container" id="mmf-fed-tooltip-content">
                </div>
            </div>

            <div class="mmf-market-popup-container">
                <div id="mmfToMarketDisplay"></div>
                <div class="tooltip-container" id="mmf-market-tooltip-content">
                </div>
            </div>
            
            <div class="icon-container FED-container">
                <span class="icon-label">중앙은행 FED</span>
                <img src="./icon/fed.jpg" alt="FED" class="icon">
            </div>
            <div class="icon-container Government-container">
                <img src="./icon/government.JPG" alt="Government TGA" class="icon">
                <span class="icon-label">미국 정부</span>
            </div>
            <div class="icon-container Market-container">
                <img src="./icon/Market.jpg" alt="Market" class="icon">
                <span class="icon-label">미국 시장(Market)</span>
                <div id="netMarketFlowDisplay"></div>
                </div>
            <div class="icon-container MMF-container">
                <img src="./icon/MMF.jpg" alt="MMF" class="icon">
                <span class="icon-label">MMF<br>(Money Market Fund)</span>
            </div>
        </div>

        <div id="graphIndicators" class="page" style="display:none;">
            <div class="indicator-section">
                <h3>미국 자금 현황</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('WTREGEN')">미 정부 TGA 잔고</button>
                    <button class="button" onclick="showGraph('WRESBAL')">미 은행 지급준비금</button>
                    <button class="button" onclick="showGraph('RRPONTSYD')">연준 역레포 자금</button>
                    <button class="button" onclick="showGraph('MMMFFAQ027S')">MMF 잔고</button>
                    <button class="button" onclick="showGraph('WALCL')">연준 전체 자산 + 부채</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>금리</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('SOFR')">SOFR 금리</button>
                    <button class="button" onclick="showGraph('FEDFUNDS')">EFFR 금리</button>
                    <button class="button" onclick="showGraph('TB3MS')">3개월 미 국채금리</button>
                    <button class="button" onclick="showGraph('TB1YR')">1년물 미 국채금리</button>
                    <button class="button" onclick="showGraph('DPCREDIT')">연준 할인율</button>
                    <button class="button" onclick="showGraph('DRBLACBS')">미 은행 연체율(전체)</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>유동성</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('M2SL')">M2</button>
                    <button class="button" onclick="showGraph('M1SL')">M1</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>자산 가격</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('NASDAQ100')">나스닥100 지수</button>
                    <button class="button" onclick="showGraph('SP500')">S&P500 지수</button>
                    <button class="button" onclick="showGraph('SP500_MCAP')">S&P500 시가총액</button>
                </div>
            </div>
        </div>

        <div id="graphPage" class="page" style="display:none;">
            <button class="back-btn" onclick="showGraphIndicators()">◄</button>
            <button class="info-btn" onclick="showInfo()">Info</button>
            <h2 id="graphTitle"></h2>
            <canvas id="myChart"></canvas>
            <div class="time-buttons">
                <button class="time-btn" onclick="updateChart('1M')">1M</button>
                <button class="time-btn" onclick="updateChart('6M')">6M</button>
                <button class="time-btn" onclick="updateChart('1Y')">1Y</button>
                <button class="time-btn" onclick="updateChart('5Y')">5Y</button>
                <button class="time-btn" onclick="updateChart('10Y')">10Y</button>
                <button class="time-btn" onclick="updateChart('All')">All</button>
            </div>
        </div>

        <div id="infoPage" class="page" style="display:none;">
            <button class="back-btn" onclick="goBackToGraph()">◄</button>
            <h2 id="infoTitle"></h2>
            <div id="infoContent"></div>
        </div>

        <div class="nav-bar">
            <button class="button" onclick="showLiquidityFlow()">유동성 현황</button>
            <button class="button" onclick="showGraphIndicators()">그래프 지표</button>
        </div>
    </div>

    <script>
        let myChart = null;
        let isDragging = false;
        let startX;
        let startScrollX;
        let currentIndicator = null;
        let currentGraphData = [];
        let dollarAnimationIntervals = [];
        const BASE_ANIMATION_DURATION = 3000;
        const BASE_DOLLAR_SIZE = 37.5;
        const NUM_DOLLAR_ANIMATIONS = 3;
        const FUNCTION_BASE_URL = '/.netlify/functions/get-csv-data';

        const indicatorTitles = {
            'WTREGEN': '미 정부 TGA 잔고',
            'WRESBAL': '미 은행 지급준비금',
            'RRPONTSYD': '연준 역레포 자금',
            'MMMFFAQ027S': 'MMF 잔고',
            'WALCL': '연준 전체 자산 + 부채',
            'SOFR': 'SOFR 금리',
            'FEDFUNDS': 'EFFR 금리',
            'TB3MS': '3개월 미 국채금리',
            'TB1YR': '1년물 미 국채금리',
            'DPCREDIT': '연준 할인율',
            'DRBLACBS': '미 은행 연체율(전체)',
            'M2SL': 'M2',
            'M1SL': 'M1',
            'NASDAQ100': '나스닥100 지수',
            'SP500': 'S&P500 지수',
            'SP500_MCAP': 'S&P500 시가총액'
        };

        const indicatorUnits = {
            'WTREGEN': 'Billions of U.S. Dollars',
            'WRESBAL': 'Billions of Dollars',
            'RRPONTSYD': 'Billions of Dollars',
            'MMMFFAQ027S': 'Billions of Dollars',
            'WALCL': 'Billions of Dollars',
            'M2SL': 'Billions of Dollars',
            'M1SL': 'Billions of Dollars',
            'SP500_MCAP': 'Billions of Dollars',
            'SOFR': 'Percent (%)',
            'FEDFUNDS': 'Percent (%)',
            'TB3MS': 'Percent (%)',
            'TB1YR': 'Percent (%)',
            'DPCREDIT': 'Percent (%)',
            'DRBLACBS': 'Percent (%)',
            'NASDAQ100': 'Index',
            'SP500': 'Index'
        };

        async function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length <= 1) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            let dateColIndex = headers.findIndex(h => h.toLowerCase() === 'date' || h.toLowerCase() === 'data');
            const valueColName = headers.find((h, i) => i !== dateColIndex);
            const valueColIdx = headers.indexOf(valueColName);

            if (dateColIndex === -1 || valueColIdx === -1) return [];

            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split(',');
                if (columns.length > Math.max(dateColIndex, valueColIdx)) {
                    const dateStr = columns[dateColIndex].trim();
                    const valueStr = columns[valueColIdx].trim();

                    const dateObj = new Date(dateStr);
                    const valueNum = parseFloat(valueStr);

                    if (!isNaN(dateObj.getTime()) && !isNaN(valueNum) && valueStr !== '.') {
                        parsedData.push({ date: dateStr, value: valueNum });
                    }
                }
            }
            return parsedData;
        }

        window.addEventListener('load', () => showPage('liquidityFlow'));

        const pages = ['liquidityFlow', 'graphIndicators', 'graphPage', 'infoPage'];

        function showPage(pageId) {
            pages.forEach(id => document.getElementById(id).style.display = id === pageId ? 'block' : 'none');
            if (pageId === 'liquidityFlow') {
                updateLiquidityFlowAnimation();
            } else {
                stopLiquidityFlowAnimation();
            }
        }

        function showLiquidityFlow() {
            showPage('liquidityFlow');
        }

        function showGraphIndicators() {
            showPage('graphIndicators');
        }

        async function showGraph(indicator) {
            currentIndicator = indicator;
            showPage('graphPage');
            document.getElementById('graphTitle').textContent = indicatorTitles[indicator] || indicator;
            
            const functionUrl = `${FUNCTION_BASE_URL}?indicator=${indicator}`;

            try {
                renderErrorMessage("데이터를 불러오는 중...");
                const response = await fetch(functionUrl);

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`'${indicatorTitles[indicator]}' 데이터를 찾을 수 없거나 불러오지 못했어요! (${response.status}: ${errorBody.error || response.statusText})`);
                }

                const text = await response.text();
                let data = await parseCSV(text);

                if (data.length === 0) {
                    renderErrorMessage(`'${indicatorTitles[indicator]}' 지표의 유효한 데이터가 없어요.`);
                    return;
                }

                data.forEach(item => {
                    if (indicator === 'WALCL') item.value /= 1000;
                    else if (indicator === 'MMMFFAQ027S' || indicator === 'SP500_MCAP') item.value /= 1000000000;
                });

                data.sort((a, b) => new Date(a.date) - new Date(b.date));
                currentGraphData = data;
                updateChart('All');

            } catch (error) {
                renderErrorMessage(`'${indicatorTitles[indicator]}' 그래프를 그릴 수 없어요! 오류: ${error.message}`);
            }
        }

        function renderChart(indicator, labels, values) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: indicatorTitles[indicator] || indicator,
                        data: values,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'yyyy-MM-dd',
                                    month: 'yyyy-MM',
                                    year: 'yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: indicatorUnits[indicator] || 'Value',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: value => {
                                    if (Math.abs(value) >= 1e12) return (value / 1e12) + 'T';
                                    if (Math.abs(value) >= 1e9) return (value / 1e9) + 'B';
                                    if (Math.abs(value) >= 1e6) return (value / 1e6) + 'M';
                                    if (Math.abs(value) >= 1e3) return (value / 1e3) + 'K';
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement.length ? 'grab' : 'default';
                    }
                }
            });

            const canvas = document.getElementById('myChart');
            canvas.onmousedown = startDragging;
            canvas.onmousemove = drag;
            canvas.onmouseup = stopDragging;
            canvas.onmouseleave = stopDragging;
            canvas.onwheel = zoomChart;
        }

        function updateChart(range) {
            if (!currentGraphData || currentGraphData.length === 0) return;

            let dataToShow = [...currentGraphData];
            const today = new Date();
            let startDate;

            switch(range) {
                case '1M':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    break;
                case '6M':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
                    break;
                case '1Y':
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    break;
                case '5Y':
                    startDate = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
                    break;
                case '10Y':
                    startDate = new Date(today.getFullYear() - 10, today.getMonth(), today.getDate());
                    break;
                default: // All
                    startDate = new Date(dataToShow[0].date);
                    break;
            }

            const filteredData = dataToShow.filter(d => new Date(d.date) >= startDate);
            const labels = filteredData.map(d => d.date);
            const values = filteredData.map(d => d.value);

            renderChart(currentIndicator, labels, values);
        }

        function renderErrorMessage(message) {
            const canvas = document.getElementById('myChart');
            const ctx = canvas.getContext('2d');
            
            if (myChart) myChart.destroy();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '20px Arial';
            ctx.fillStyle = 'red';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, canvas.width / 2, canvas.height / 2);
        }

        function startDragging(e) {
            isDragging = true;
            startX = e.pageX;
            startScrollX = myChart.options.scales.x.realmin; // Save the initial scroll position
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.pageX - startX;
            const newMin = startScrollX - (dx / myChart.chartArea.width) * (myChart.options.scales.x.realmax - myChart.options.scales.x.realmin);
            myChart.options.scales.x.min = newMin;
            myChart.update('none');
        }

        function stopDragging() {
            isDragging = false;
        }

        function zoomChart(e) {
            e.preventDefault();
            const chart = myChart;
            const scale = chart.scales.x;
            const center = scale.getValueForPixel(e.offsetX);
            let newMax = scale.max;
            let newMin = scale.min;
            const zoomFactor = 1.1;

            if (e.deltaY < 0) { // Zoom in
                newMax = center + (newMax - center) / zoomFactor;
                newMin = center - (center - newMin) / zoomFactor;
            } else { // Zoom out
                newMax = center + (newMax - center) * zoomFactor;
                newMin = center - (center - newMin) * zoomFactor;
            }

            // Ensure min does not go before the first data point, and max does not go after the last.
            const minBound = new Date(currentGraphData[0].date).getTime();
            const maxBound = new Date(currentGraphData[currentGraphData.length - 1].date).getTime();
            
            if (newMin < minBound) newMin = minBound;
            if (newMax > maxBound) newMax = maxBound;
            if (newMax - newMin < 86400000 * 30) { // Limit max zoom in to 30 days
                newMax = newMin + 86400000 * 30;
                if (newMax > maxBound) {
                    newMax = maxBound;
                    newMin = maxBound - 86400000 * 30;
                }
            }


            chart.options.scales.x.min = newMin;
            chart.options.scales.x.max = newMax;
            chart.update('none');
        }

        function showInfo() {
            const infoPage = document.getElementById('infoPage');
            const infoTitle = document.getElementById('infoTitle');
            const infoContent = document.getElementById('infoContent');
            showPage('infoPage');
            infoTitle.textContent = indicatorTitles[currentIndicator] || currentIndicator;
            
            let description = '';
            // FRED API 지표 설명 검색
            const descriptions = {
                'WTREGEN': '<p>미 재무부 일반계정(TGA)은 미국 정부가 재정 지출을 위해 보유하고 있는 예금 계좌입니다. 잔고가 증가하면 시장에서 유동성을 흡수하고, 감소하면 시장에 유동성을 공급합니다.</p>',
                'WRESBAL': '<p>연방준비제도(FED)에 예치된 은행들의 지급준비금입니다. 은행 간 유동성을 나타내는 중요한 지표입니다.</p>',
                'RRPONTSYD': '<p>연준의 역환매조건부채권(RRP) 잔고입니다. 은행 및 MMF들이 남는 자금을 연준에 맡기는 것을 의미하며, 잔고가 증가하면 시장에서 유동성을 흡수합니다.</p>',
                'MMMFFAQ027S': '<p>미국 머니마켓펀드(MMF)의 총 자산 규모를 나타냅니다.</p>',
                'WALCL': '<p>연준의 대차대조표 총자산 규모를 나타내는 지표입니다. 양적완화(QE)나 양적긴축(QT)의 규모를 파악하는 데 사용됩니다. (단위: Trillions of Dollars로 환산됨)</p>',
                'SOFR': '<p>담보부 금리인 SOFR(Secured Overnight Financing Rate)입니다. 미국 금융시장에서의 초단기 자금조달 비용을 나타내는 대표적인 지표입니다.</p>',
                'FEDFUNDS': '<p>연방기금금리(EFFR)입니다. 미국 연방공개시장위원회(FOMC)에서 결정되는 정책 금리로, 통화 정책의 핵심 지표입니다.</p>',
                'TB3MS': '<p>3개월 만기 미국 국채 수익률입니다. 단기 시장 금리 동향을 파악하는 데 유용합니다.</p>',
                'TB1YR': '<p>1년 만기 미국 국채 수익률입니다. 단기 시장 금리 동향을 파악하는 데 유용합니다.</p>',
                'DPCREDIT': '<p>연준의 재할인율(Discount Window Rate)입니다. 연준이 은행에 자금을 대출해줄 때 적용하는 금리입니다.</p>',
                'DRBLACBS': '<p>미국 은행의 전체 대출에 대한 연체율 지표입니다.</p>',
                'M2SL': '<p>통화량 지표인 M2입니다. 현금, 요구불예금, 저축성 예금 등을 포함한 광의 통화량입니다.</p>',
                'M1SL': '<p>통화량 지표인 M1입니다. 현금과 요구불예금을 포함한 협의 통화량입니다.</p>',
                'NASDAQ100': '<p>나스닥100 지수입니다. 나스닥 시장의 시가총액 상위 100개 비금융 기업으로 구성된 주가 지수입니다.</p>',
                'SP500': '<p>S&P500 지수입니다. 미국의 대표적인 500개 대형 기업의 주가 지수입니다.</p>',
                'SP500_MCAP': '<p>S&P500에 포함된 기업들의 총 시가총액을 나타냅니다. (단위: Billions of Dollars로 환산됨)</p>'
            };
            description = descriptions[currentIndicator] || '<p>이 지표에 대한 설명이 없습니다.</p>';
            infoContent.innerHTML = description;
        }

        function goBackToGraph() {
            showPage('graphPage');
        }

        const dollarAnimations = [
            { id: 'dollarAnimationToMarket', animationClass: 'animated-dollar-to-market', direction: 'positive', elements: [] },
            { id: 'dollarAnimationToFED', animationClass: 'animated-dollar-to-fed', direction: 'negative', elements: [] },
            { id: 'dollarAnimationToGovernment', animationClass: 'animated-dollar-to-government', direction: 'negative', elements: [] },
            { id: 'dollarAnimationFromGovernment', animationClass: 'animated-dollar-from-government', direction: 'positive', elements: [] },
            { id: 'dollarAnimationFromMmfToFed', animationClass: 'animated-dollar-from-mmf-to-fed', direction: 'negative', elements: [] },
            { id: 'dollarAnimationFromFedToMmf', animationClass: 'animated-dollar-from-fed-to-mmf', direction: 'positive', elements: [] },
            { id: 'dollarAnimationFromMmfToMarket_parabolic', animationClass: 'animated-dollar-from-mmf-to-market_parabolic', direction: 'positive', elements: [] },
            { id: 'dollarAnimationFromMarketToMmf_parabolic', animationClass: 'animated-dollar-from-market-to-mmf_parabolic', direction: 'negative', elements: [] }
        ];

        let displayElements = {};
        const displayIds = ['tgaSlopeDisplay', 'fedLiquidityDisplay', 'mmfToRrpDisplay', 'mmfToMarketDisplay', 'netMarketFlowDisplay'];

        displayIds.forEach(id => {
            displayElements[id] = document.getElementById(id);
        });

        const tooltipContents = {
            'tga-tooltip-content': { title: '미 정부 TGA 잔고', date: '2024-05-16', change: '-43.08 B $/Month', description: '미 정부가 재정 지출을 위해 보유하고 있는 예금 계좌의 잔고. 잔고가 증가하면 시장의 유동성을 흡수하고, 감소하면 시장에 유동성을 공급합니다.' },
            'fed-tooltip-content': { title: '연준 유동성', date: '2024-05-16', change: '-12.03 B $/Month', description: '연준의 대차대조표 변화와 역레포 자금의 합산 유동성. 값이 양수면 시장 유동성 공급, 음수면 흡수.' },
            'mmf-fed-tooltip-content': { title: 'MMF->연준', date: '2024-05-16', change: '-10.74 B $/Month', description: 'MMF 자금이 연준으로 이동하는 흐름. 값이 양수면 연준으로 자금 이동, 음수면 연준에서 시장으로 자금 이동.' },
            'mmf-market-tooltip-content': { title: 'MMF->시장', date: '2024-05-16', change: '+32.42 B $/Month', description: 'MMF 자금이 시장으로 이동하는 흐름. 값이 양수면 시장으로 자금 이동, 음수면 시장에서 MMF로 자금 이동.' }
        };

        function updateTooltips(data) {
            for (const key in tooltipContents) {
                if (tooltipContents.hasOwnProperty(key)) {
                    const tooltip = document.getElementById(key);
                    if (tooltip) {
                        const tooltipData = tooltipContents[key];
                        tooltip.innerHTML = `
                            <p><strong>${tooltipData.title}</strong></p>
                            <p>최근 데이터 날짜: ${data[key.replace('-tooltip-content', '') + '_date'] || tooltipData.date}</p>
                            <p>변화량: ${data[key.replace('-tooltip-content', '') + '_change'] || tooltipData.change}</p>
                            <p>${tooltipData.description}</p>
                            <span class="update-date">데이터 업데이트일: ${tooltipData.date}</span>
                        `;
                    }
                }
            }
        }

        async function updateLiquidityFlowAnimation() {
            stopLiquidityFlowAnimation();
            
            // 데이터는 임시로 고정된 값을 사용
            const mockData = {
                'tgaSlope_change': '-43.08 B $/Month',
                'tgaSlope_value': -43.08,
                'tgaSlope_date': '2024-05-16',
                
                'fedLiquidity_change': '-12.03 B $/Month',
                'fedLiquidity_value': -12.03,
                'fedLiquidity_date': '2024-05-16',
                
                'mmfToRrp_change': '-10.74 B $/Month',
                'mmfToRrp_value': -10.74,
                'mmfToRrp_date': '2024-05-16',

                'mmfToMarket_change': '+32.42 B $/Month',
                'mmfToMarket_value': 32.42,
                'mmfToMarket_date': '2024-05-16',
                
                'net_market_flow_value': -12.03 - (-43.08) - 32.42,
            };
            
            // 팝업창 툴팁 내용 업데이트
            const tooltipData = {
                 'tga-tooltip-content': {
                    title: '미 정부 TGA 잔고',
                    date: mockData.tgaSlope_date,
                    change: mockData.tgaSlope_change,
                    description: tooltipContents['tga-tooltip-content'].description
                },
                'fed-tooltip-content': {
                    title: '연준 유동성',
                    date: mockData.fedLiquidity_date,
                    change: mockData.fedLiquidity_change,
                    description: tooltipContents['fed-tooltip-content'].description
                },
                'mmf-fed-tooltip-content': {
                    title: 'MMF->연준',
                    date: mockData.mmfToRrp_date,
                    change: mockData.mmfToRrp_change,
                    description: tooltipContents['mmf-fed-tooltip-content'].description
                },
                'mmf-market-tooltip-content': {
                    title: 'MMF->시장',
                    date: mockData.mmfToMarket_date,
                    change: mockData.mmfToMarket_change,
                    description: tooltipContents['mmf-market-tooltip-content'].description
                }
            };

            for (const key in tooltipData) {
                if (tooltipData.hasOwnProperty(key)) {
                    const tooltip = document.getElementById(key);
                    if (tooltip) {
                        const data = tooltipData[key];
                        tooltip.innerHTML = `
                            <p><strong>${data.title}</strong></p>
                            <p>최근 데이터 날짜: ${data.date}</p>
                            <p>변화량: ${data.change}</p>
                            <p>${data.description}</p>
                            <span class="update-date">데이터 업데이트일: ${data.date}</span>
                        `;
                    }
                }
            }

            // 개별 지표 계산값 표시
            const displays = {
                tgaSlopeDisplay: document.getElementById('tgaSlopeDisplay'),
                fedLiquidityDisplay: document.getElementById('fedLiquidityDisplay'),
                mmfToRrpDisplay: document.getElementById('mmfToRrpDisplay'),
                mmfToMarketDisplay: document.getElementById('mmfToMarketDisplay'),
                net_market_flow: document.getElementById('netMarketFlowDisplay')
            };

            // TGA 잔고
            const tgaSign = mockData.tgaSlope_value > 0 ? '+' : '';
            const tgaColor = mockData.tgaSlope_value > 0 ? 'slope-positive' : 'slope-negative';
            if (displays.tgaSlopeDisplay) {
                displays.tgaSlopeDisplay.innerHTML = `<span class="${tgaColor}">${tgaSign}${mockData.tgaSlope_value.toFixed(2)} B $/Month</span>`;
            }

            // 연준 유동성
            const fedSign = mockData.fedLiquidity_value > 0 ? '+' : '';
            const fedColor = mockData.fedLiquidity_value > 0 ? 'slope-positive' : 'slope-negative';
            if (displays.fedLiquidityDisplay) {
                displays.fedLiquidityDisplay.innerHTML = `<span class="${fedColor}">${fedSign}${mockData.fedLiquidity_value.toFixed(2)} B $/Month</span>`;
            }

            // MMF -> 연준
            const mmfRrpSign = mockData.mmfToRrp_value > 0 ? '+' : '';
            const mmfRrpColor = mockData.mmfToRrp_value > 0 ? 'slope-positive' : 'slope-negative';
            if (displays.mmfToRrpDisplay) {
                displays.mmfToRrpDisplay.innerHTML = `<span class="${mmfRrpColor}">${mmfRrpSign}${mockData.mmfToRrp_value.toFixed(2)} B $/Month</span>`;
            }
            
            // MMF -> 시장
            const mmfMarketSign = mockData.mmfToMarket_value > 0 ? '+' : '';
            const mmfMarketColor = mockData.mmfToMarket_value > 0 ? 'slope-positive' : 'slope-negative';
            if (displays.mmfToMarketDisplay) {
                displays.mmfToMarketDisplay.innerHTML = `<span class="${mmfMarketColor}">${mmfMarketSign}${mockData.mmfToMarket_value.toFixed(2)} B $/Month</span>`;
            }

            // 순수 시장 유동성 계산 및 표시
            if(displays.net_market_flow) {
                const netMarketFlow = mockData.fedLiquidity_value - mockData.tgaSlope_value - mockData.mmfToMarket_value;
                const sign = netMarketFlow > 0 ? '+' : '';
                const colorClass = netMarketFlow > 0 ? 'slope-positive' : 'slope-negative';
                displays.net_market_flow.innerHTML = `시장 Total 유동 공급량 = <span class="${colorClass}">${sign}${netMarketFlow.toFixed(2)} B $/Month</span>`;
            }


            // 애니메이션 객체 준비
            dollarAnimations.forEach(anim => {
                anim.elements = [];
                for (let i = 0; i < NUM_DOLLAR_ANIMATIONS; i++) {
                    const dollar = document.createElement('img');
                    dollar.src = './icon/dollar.png';
                    dollar.alt = 'dollar';
                    dollar.className = 'dollar-animated-object';
                    document.getElementById('liquidityFlow').appendChild(dollar);
                    anim.elements.push(dollar);
                }
            });

            // 애니메이션 시작
            startAnimation('dollarAnimationToMarket', mockData.fedLiquidity_value, 1, 'dollarFlowToMarket');
            startAnimation('dollarAnimationToFED', mockData.fedLiquidity_value, 1, 'dollarFlowToFED');
            startAnimation('dollarAnimationFromGovernment', mockData.tgaSlope_value, 1, 'dollarFlowFromGovernment');
            startAnimation('dollarAnimationToGovernment', mockData.tgaSlope_value, 1, 'dollarFlowToGovernment');
            startAnimation('dollarAnimationFromFedToMmf', mockData.mmfToRrp_value, 1, 'dollarFlowFromFedToMmf');
            startAnimation('dollarAnimationFromMmfToFed', mockData.mmfToRrp_value, 1, 'dollarFlowFromMmfToFed');
            startAnimation('dollarAnimationFromMmfToMarket_parabolic', mockData.mmfToMarket_value, 1, 'dollarFlowFromMmfToMarket_parabolic');
            startAnimation('dollarAnimationFromMarketToMmf_parabolic', mockData.mmfToMarket_value, 1, 'dollarFlowFromMarketToMmf_parabolic');

        }
        
        function startAnimation(animationId, value, factor, animationClassName) {
            const anim = dollarAnimations.find(a => a.id === animationId);
            if (!anim) return;

            const direction = anim.direction;
            const animate = (val) => {
                if ((val > 0 && direction === 'positive') || (val < 0 && direction === 'negative')) {
                    const duration = BASE_ANIMATION_DURATION + Math.abs(val) * 5;
                    const numDollars = Math.min(NUM_DOLLAR_ANIMATIONS, Math.ceil(Math.abs(val) / 5) || 1);
                    const dollarSize = BASE_DOLLAR_SIZE * (1 + Math.abs(val) * 0.05);

                    for (let i = 0; i < numDollars; i++) {
                        setTimeout(() => {
                            const dollar = anim.elements[i];
                            dollar.style.width = `${dollarSize}px`;
                            dollar.style.height = `${dollarSize}px`;
                            dollar.style.animation = `${animationClassName} ${duration}ms linear forwards`;
                            dollar.style.opacity = 1;
                        }, (duration / numDollars) * i);
                    }
                    dollarAnimationIntervals.push(setTimeout(() => {
                        anim.elements.forEach(dollar => {
                            dollar.style.animation = 'none';
                            dollar.offsetHeight; /* trigger reflow */
                            dollar.style.opacity = 0;
                        });
                        startAnimation(animationId, value, factor, animationClassName);
                    }, duration + 100)); // 애니메이션 끝난 후 잠시 대기
                }
            };
            animate(value);
        }


        function stopLiquidityFlowAnimation() {
            dollarAnimationIntervals.forEach(interval => clearTimeout(interval));
            dollarAnimationIntervals = [];
            document.querySelectorAll('.dollar-animated-object').forEach(el => el.remove());
        }
        
        // 초기화
        window.onload = function() {
            showPage('liquidityFlow');
        };

    </script>
</body>
</html>