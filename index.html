<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; min-height: 100vh; }
        .header { text-align: center; padding: 10px; background: #007bff; color: white; }
        .back-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; cursor: pointer; font-size: 24px; font-weight: bold; color: black; width: 30px; text-align: center; }
        .back-btn::before { content: "◄"; font-size: 36px; }
        .info-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; font-size: 20px; }
        .button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .button:hover { background: #0056b3; }

        #liquidityFlow {
            text-align: center;
            padding: 20px;
            position: relative;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #liquidityFlow .icon-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
        }
        #liquidityFlow .icon {
            width: 80px;
            height: 80px;
            display: block;
            object-fit: contain;
        }
        #liquidityFlow .icon-label {
            font-weight: bold;
            color: black;
            font-size: 14px;
            white-space: nowrap;
            margin-top: 5px;
        }

        .FED-container .icon-label {
            order: -1;
            margin-bottom: 5px;
            margin-top: 0;
        }

        .FED-container { top: 20%; left: 50%; }
        .Government-container { top: 50%; left: 20%; }
        .Market-container { top: 80%; left: 50%; }
        .MMF-container { top: 50%; left: 80%; }

        #tgaSlopeDisplay, #fedLiquidityDisplay, #mmfToRrpDisplay, #mmfToMarketDisplay, #mmfToGovernmentDisplay {
            position: absolute;
            transform: translateX(-50%);
            font-size: 0.8em;
            font-weight: bold;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 6px;
            border-radius: 5px;
            border: 1px solid #ccc;
            text-align: center;
        }

        #tgaSlopeDisplay {
            top: calc(50% + 80px + 14px + 10px);
            left: 20%;
        }
        #fedLiquidityDisplay {
            top: calc(50% + 80px + 14px + 30px);
            left: 20%;
        }
        
        #mmfToRrpDisplay {
            top: calc(50% - 80px - 10px); /* MMF 아이콘 위에 위치 */
            left: 80%;
        }

        #mmfToMarketDisplay {
            top: calc(50% + 80px + 14px + 10px); /* MMF 아이콘과 라벨 아래에 위치 */
            left: 80%;
        }

        #mmfToGovernmentDisplay {
            top: calc(50% - 80px - 30px); /* MMF 아이콘 위에 위치 (RRP 위에) */
            left: 80%;
        }

        .slope-positive { color: blue; }
        .slope-negative { color: red; }

        .dollar-animated-object {
            position: absolute;
            width: 37.5px;
            height: 37.5px;
            object-fit: contain;
            opacity: 0;
            z-index: 5;
        }

        /* 기존 애니메이션 */
        @keyframes dollarFlowToMarket {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 20%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 20%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
        }

        @keyframes dollarFlowToFED {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 20%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 20%; }
        }

        @keyframes dollarFlowToGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 50%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 50%; }
        }

        @keyframes dollarFlowFromGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 50%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 50%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
        }

        /* 기존 MMF 애니메이션 */
        @keyframes dollarFlowFromMmfToFed {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 20%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 20%; }
        }
        @keyframes dollarFlowFromFedToMmf {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 20%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 20%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
        }
        @keyframes dollarFlowFromMmfToMarket {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
        }
        @keyframes dollarFlowFromMarketToMmf {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 50%; top: 80%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 50%; top: 80%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
        }

        /* 새 MMF to Government 애니메이션 */
        @keyframes dollarFlowFromMmfToGovernment {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 50%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 50%; }
        }
        @keyframes dollarFlowFromGovernmentToMmf {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 20%; top: 50%; }
            20% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 20%; top: 50%; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; left: 80%; top: 50%; }
            100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; left: 80%; top: 50%; }
        }

        .animated-dollar-to-market { animation: dollarFlowToMarket var(--animation-duration) linear forwards; }
        .animated-dollar-to-fed { animation: dollarFlowToFED var(--animation-duration) linear forwards; }
        .animated-dollar-to-government { animation: dollarFlowToGovernment var(--animation-duration) linear forwards; }
        .animated-dollar-from-government { animation: dollarFlowFromGovernment var(--animation-duration) linear forwards; }
        
        .animated-dollar-from-mmf-to-fed { animation: dollarFlowFromMmfToFed var(--animation-duration) linear forwards; }
        .animated-dollar-from-fed-to-mmf { animation: dollarFlowFromFedToMmf var(--animation-duration) linear forwards; }
        .animated-dollar-from-mmf-to-market { animation: dollarFlowFromMmfToMarket var(--animation-duration) linear forwards; }
        .animated-dollar-from-market-to-mmf { animation: dollarFlowFromMarketToMmf var(--animation-duration) linear forwards; }
        .animated-dollar-from-mmf-to-government { animation: dollarFlowFromMmfToGovernment var(--animation-duration) linear forwards; }
        .animated-dollar-from-government-to-mmf { animation: dollarFlowFromGovernmentToMmf var(--animation-duration) linear forwards; }

        #graphIndicators { padding: 20px; text-align: center; }
        .indicator-section { margin-bottom: 20px; }
        .indicator-section h3 { font-size: 18px; margin-bottom: 10px; color: #007bff; }
        .indicator-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        #graphPage {
            text-align: center;
            padding: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #graphPage canvas {
            max-width: 100%;
            width: 100%;
            height: 400px;
            cursor: grab;
            flex-grow: 1;
        }

        #infoPage { padding: 20px; text-align: center; }
        .time-buttons { margin: 10px 0; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .time-btn { padding: 5px 10px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .time-btn:hover { background-color: #dee2e6; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #007bff; padding: 10px; display: flex; justify-content: space-around; }

        @media (max-width: 600px) {
            .container { padding: 10px; }
            .back-btn { top: 5px; left: 5px; }
            .info-btn { top: 5px; right: 5px; }

            #liquidityFlow .icon { width: 60px; height: 60px; }
            #liquidityFlow .icon-label { font-size: 12px; }

            .FED-container { top: 15%; left: 50%; }
            .Government-container { top: 40%; left: 15%; }
            .Market-container { top: 85%; left: 50%; }
            .MMF-container { top: 40%; left: 85%; }

            #tgaSlopeDisplay, #fedLiquidityDisplay, #mmfToRrpDisplay, #mmfToMarketDisplay, #mmfToGovernmentDisplay {
                font-size: 0.7em;
                padding: 2px 4px;
                white-space: normal;
            }

            #tgaSlopeDisplay { top: calc(40% + 60px + 12px + 15px); left: 15%; }
            #fedLiquidityDisplay { top: calc(40% + 60px + 12px + 35px); left: 15%; }
            #mmfToRrpDisplay { top: calc(40% - 60px - 10px); left: 85%; }
            #mmfToMarketDisplay { top: calc(40% + 60px + 12px + 15px); left: 85%; }
            #mmfToGovernmentDisplay { top: calc(40% - 60px - 30px); left: 85%; }

            .dollar-animated-object {
                width: 22.5px;
                height: 22.5px;
            }

            .indicator-buttons { grid-template-columns: 1fr; max-width: 100%; }
            .button { margin: 5px 0; }
            .time-buttons { justify-content: space-around; }
            .time-btn {
                padding: 5px 8px;
                font-size: 0.85em;
                margin: 2px;
                flex-basis: auto;
                width: auto;
            }
            #graphPage canvas {
                width: 100%;
                height: 300px;
            }
            .nav-bar { padding: 5px; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="container">
        <div id="liquidityFlow" class="page">
            <div id="tgaSlopeDisplay"></div>
            <div id="fedLiquidityDisplay"></div>
            <div id="mmfToRrpDisplay"></div>
            <div id="mmfToMarketDisplay"></div>
            <div id="mmfToGovernmentDisplay"></div>

            <div class="icon-container FED-container">
                <span class="icon-label">중앙은행 FED</span>
                <img src="./icon/fed.jpg" alt="FED" class="icon">
            </div>
            <div class="icon-container Government-container">
                <img src="./icon/government.JPG" alt="Government TGA" class="icon">
                <span class="icon-label">미국 정부</span>
            </div>
            <div class="icon-container Market-container">
                <img src="./icon/Market.jpg" alt="Market" class="icon">
                <span class="icon-label">미국 시장(Market)</span>
            </div>
            <div class="icon-container MMF-container">
                <img src="./icon/MMF.jpg" alt="MMF" class="icon">
                <span class="icon-label">MMF(Money Market Fund)</span>
            </div>
        </div>

        <div id="graphIndicators" class="page" style="display:none;">
            <div class="indicator-section">
                <h3>미국 자금 현황</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('WTREGEN')">미 정부 TGA 잔고</button>
                    <button class="button" onclick="showGraph('WRESBAL')">미 은행 지급준비금</button>
                    <button class="button" onclick="showGraph('RRPONTSYD')">연준 역레포 자금</button>
                    <button class="button" onclick="showGraph('MMMFFAQ027S')">MMF 잔고</button>
                    <button class="button" onclick="showGraph('WALCL')">연준 전체 자산 + 부채</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>금리</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('SOFR')">SOFR 금리</button>
                    <button class="button" onclick="showGraph('FEDFUNDS')">EFFR 금리</button>
                    <button class="button" onclick="showGraph('TB3MS')">3개월 미 국채금리</button>
                    <button class="button" onclick="showGraph('TB1YR')">1년물 미 국채금리</button>
                    <button class="button" onclick="showGraph('DPCREDIT')">연준 할인율</button>
                    <button class="button" onclick="showGraph('DRBLACBS')">미 은행 연체율(전체)</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>유동성</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('M2SL')">M2</button>
                    <button class="button" onclick="showGraph('M1SL')">M1</button>
                </div>
            </div>
            <div class="indicator-section">
                <h3>자산 가격</h3>
                <div class="indicator-buttons">
                    <button class="button" onclick="showGraph('NASDAQ100')">나스닥100 지수</button>
                    <button class="button" onclick="showGraph('SP500')">S&P500 지수</button>
                    <button class="button" onclick="showGraph('SP500_MCAP')">S&P500 시가총액</button>
                </div>
            </div>
        </div>

        <div id="graphPage" class="page" style="display:none;">
            <button class="back-btn" onclick="showGraphIndicators()">◄</button>
            <button class="info-btn" onclick="showInfo()">Info</button>
            <h2 id="graphTitle"></h2>
            <canvas id="myChart"></canvas>
            <div class="time-buttons">
                <button class="time-btn" onclick="updateChart('1M')">1M</button>
                <button class="time-btn" onclick="updateChart('6M')">6M</button>
                <button class="time-btn" onclick="updateChart('1Y')">1Y</button>
                <button class="time-btn" onclick="updateChart('5Y')">5Y</button>
                <button class="time-btn" onclick="updateChart('10Y')">10Y</button>
                <button class="time-btn" onclick="updateChart('All')">All</button>
            </div>
        </div>

        <div id="infoPage" class="page" style="display:none;">
            <button class="back-btn" onclick="goBackToGraph()">◄</button>
            <h2 id="infoTitle"></h2>
            <div id="infoContent"></div>
        </div>

        <div class="nav-bar">
            <button class="button" onclick="showLiquidityFlow()">유동성 현황</button>
            <button class="button" onclick="showGraphIndicators()">그래프 지표</button>
        </div>
    </div>

    <script>
        let myChart = null;
        let isDragging = false;
        let startX;
        let startScrollX;
        let currentIndicator = null;
        let currentGraphData = [];
        let dollarAnimationIntervals = [];
        const DOLLAR_ANIMATION_DURATION = 3000;
        const DOLLAR_SPAWN_INTERVAL = DOLLAR_ANIMATION_DURATION / 3;
        const NUM_DOLLAR_ANIMATIONS = 3;

        const FUNCTION_BASE_URL = '/.netlify/functions/get-csv-data';

        const indicatorTitles = {
            'WTREGEN': '미 정부 TGA 잔고',
            'WRESBAL': '미 은행 지급준비금',
            'RRPONTSYD': '연준 역레포 자금',
            'MMMFFAQ027S': 'MMF 잔고',
            'WALCL': '연준 전체 자산 + 부채',
            'SOFR': 'SOFR 금리',
            'FEDFUNDS': 'EFFR 금리',
            'TB3MS': '3개월 미 국채금리',
            'TB1YR': '1년물 미 국채금리',
            'DPCREDIT': '연준 할인율',
            'DRBLACBS': '미 은행 연체율(전체)',
            'M2SL': 'M2',
            'M1SL': 'M1',
            'NASDAQ100': '나스닥100 지수',
            'SP500': 'S&P500 지수',
            'SP500_MCAP': 'S&P500 시가총액'
        };

        async function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length <= 1) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            
            // 'Date' 또는 'data' 컬럼 찾기 (대소문자 무시)
            let dateColIndex = headers.findIndex(h => h.toLowerCase() === 'date');
            if (dateColIndex === -1) {
                dateColIndex = headers.findIndex(h => h.toLowerCase() === 'data');
            }

            // 날짜가 아닌 다른 컬럼을 값 컬럼으로 찾기
            const valueColName = headers.find((h, i) => i !== dateColIndex);
            const valueColIdx = headers.indexOf(valueColName);

            if (dateColIndex === -1 || valueColIdx === -1) {
                console.error("CSV 헤더에서 날짜('Date' 또는 'data') 또는 값 컬럼을 찾을 수 없습니다:", headers.join(', '));
                return [];
            }

            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split(',');
                if (columns.length > Math.max(dateColIndex, valueColIdx)) {
                    const dateStr = columns[dateColIndex].trim();
                    const valueStr = columns[valueColIdx].trim();

                    const dateObj = new Date(dateStr);
                    const valueNum = parseFloat(valueStr);

                    if (!isNaN(dateObj.getTime()) && !isNaN(valueNum) && valueStr !== '.') {
                        parsedData.push({
                            date: dateStr,
                            value: valueNum
                        });
                    }
                }
            }
            return parsedData;
        }

        window.addEventListener('load', async function() {
            showPage('liquidityFlow');
        });

        const pages = ['liquidityFlow', 'graphIndicators', 'graphPage', 'infoPage'];

        function showPage(pageId) {
            pages.forEach(id => document.getElementById(id).style.display = id === pageId ? 'block' : 'none');
            if (pageId === 'liquidityFlow') {
                updateLiquidityFlowAnimation();
            } else {
                stopLiquidityFlowAnimation();
            }
        }

        function showLiquidityFlow() { showPage('liquidityFlow'); }
        function showGraphIndicators() { showPage('graphIndicators'); }

        async function showGraph(indicator) {
            currentIndicator = indicator;
            showPage('graphPage');
            document.getElementById('graphTitle').textContent = indicatorTitles[indicator] || indicator;

            const functionUrl = `${FUNCTION_BASE_URL}?indicator=${indicator}`;

            try {
                renderErrorMessage("데이터를 불러오는 중...");
                const response = await fetch(functionUrl);
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`'${indicatorTitles[indicator]}' 데이터를 찾을 수 없거나 불러오지 못했어요! (${response.status}: ${errorBody.error || response.statusText})`);
                }
                const text = await response.text();
                const data = await parseCSV(text);

                if (data.length === 0) {
                     renderErrorMessage(`'${indicatorTitles[indicator]}' 지표의 유효한 데이터가 없어요.`);
                     return;
                }

                data.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                currentGraphData = data;
                renderChart(indicator, currentGraphData.map(item => item.date), currentGraphData.map(item => item.value));
                updateChart('All');

            } catch (error) {
                console.error(`CSV 로드 오류 for ${indicator}:`, error);
                renderErrorMessage(`'${indicatorTitles[indicator]}' 그래프를 그릴 수 없어요! 오류: ${error.message}`);
            }
        }

        function renderChart(indicator, labels, values) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }

            try {
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: indicatorTitles[indicator] || indicator,
                            data: values,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    tooltipFormat: 'yyyy-MM-dd',
                                    displayFormats: {
                                        day: 'yyyy-MM-dd',
                                        month: 'yyyy-MM',
                                        quarter: 'yyyy [Q]Q',
                                        year: 'yyyy'
                                    }
                                },
                                title: { display: true, text: 'Date' },
                                grid: { display: true },
                                reverse: false
                            },
                            y: {
                                title: { display: true, text: 'Value' },
                                grid: { display: true },
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value, index, values) {
                                        if (Math.abs(value) >= 1000000000000) return (value / 1000000000000) + 'T';
                                        if (Math.abs(value) >= 1000000000) return (value / 1000000000) + 'B';
                                        if (Math.abs(value) >= 1000000) return (value / 1000000) + 'M';
                                        if (Math.abs(value) >= 1000) return (value / 1000) + 'K';
                                        return value;
                                    }
                                }
                            }
                        },
                        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } },
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement.length ? 'grab' : 'default';
                        }
                    }
                });

                const canvas = document.getElementById('myChart');
                canvas.removeEventListener('